#!/usr/bin/env bash

CONDA_INSTALL_URL="https://repo.continuum.io/miniconda/Miniconda2-4.5.4-Linux-x86_64.sh"
CONDA_INSTALL_SCRIPT="Miniconda2-4.5.4-Linux-x86_64.sh"
CONDA_HOME="/app/.heroku/miniconda"
CONDA_BIN_DIR="${CONDA_HOME}/bin"
CONDA="${CONDA_BIN_DIR}/conda"

ENV_NAME="heroku-env"
ENV_SPEC_FILE="environment.yml"

unset PYTHONPATH
if [ ! -d ${CONDA_HOME} ]; then
    puts-step "downloading miniconda"
    curl -s ${CONDA_INSTALL_URL} -o ${CONDA_INSTALL_SCRIPT}

    puts-step "installing miniconda"
    bash ${CONDA_INSTALL_SCRIPT} -p ${CONDA_HOME} -b | indent
    rm -f ${CONDA_INSTALL_SCRIPT}

    # puts-step "updating miniconda to latest version"
    # ${CONDA} update conda conda-env --yes | indent
    # ${CONDA} install psutil

    # puts-step $(${CONDA} --version)" installed"


puts-step "updating miniconda to latest version"
puts-step "listing home dir"
ls ~/
puts-step "listing /app"
ls /app/
puts-step "listing _CONDA_HOME $CONDA_HOME"
ls $CONDA_HOME
puts-step "listing _CONDA_BIN_DIR $CONDA_BIN_DIR"
ls $CONDA_BIN_DIR
. ${CONDA_BIN_DIR}/activate
${CONDA} update conda conda-env --yes | indent
${CONDA} update psutil

puts-step $(${CONDA} --version)" installed"



if [ -f ${ENV_SPEC_FILE} ]; then
    if ${CONDA} env list | grep ${ENV_NAME}; then
        puts-step "updating the ${ENV_NAME} environment"
        ${CONDA} env update --name=${ENV_NAME} --file ${ENV_SPEC_FILE} || true
        puts-step "updated the ${ENV_NAME} environment"
    else
        puts-step "creating the ${ENV_NAME} environment"
        ${CONDA} env create --name=${ENV_NAME} --file=${ENV_SPEC_FILE}
        puts-step "created the ${ENV_NAME} environment"
    fi
fi

puts-step "cleaning up miniconda environment"
source activate ${ENV_NAME}
conda clean --tarballs --packages --yes > /dev/null
