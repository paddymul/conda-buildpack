#!/usr/bin/env bash

CONDA_INSTALL_URL="http://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh"
CONDA_INSTALL_SCRIPT="miniconda_linux-x86_64.sh"
CONDA_HOME="/app/.heroku/miniconda"
CONDA_BIN_DIR="${CONDA_HOME}/bin"
CONDA="${CONDA_BIN_DIR}/conda"

ENV_NAME="heroku-env"
ENV_SPEC_FILE="environment.yml"

if [ ! -d ${CONDA_HOME} ]; then
    puts-step "downloading miniconda"
    curl -s ${CONDA_INSTALL_URL} -o ${CONDA_INSTALL_SCRIPT}

    puts-step "installing miniconda"
    bash ${CONDA_INSTALL_SCRIPT} -p ${CONDA_HOME} -b | indent
    rm -f ${CONDA_INSTALL_SCRIPT}

    puts-step "updating miniconda to latest version"
    ${CONDA} update conda --yes | indent

    puts-step $(${CONDA} --version)" installed"
else
    puts-step "updating miniconda to latest version"
    ${CONDA} update conda --yes | indent
     
    puts-step $(${CONDA} --version)" installed"
fi


if [ -f ${ENV_SPEC_FILE} ]; then
    if ${CONDA} env list | grep ${ENV_NAME}; then
        puts-step "updating the ${ENV_NAME} environment"
        ${CONDA} env update --name=${ENV_NAME} --file ${ENV_SPEC_FILE} || true
        puts-step "updated the ${ENV_NAME} environment"
    else
        puts-step "creating the ${ENV_NAME} environment"
        ${CONDA} env create --name=${ENV_NAME} --file=${ENV_SPEC_FILE}
        puts-step "created the ${ENV_NAME} environment"
    fi
fi

source activate ${ENV_NAME}
puts-step "cleaning up miniconda environment"
conda clean --tarballs --packages --yes > /dev/null
source deactivate
